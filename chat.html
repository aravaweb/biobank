<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" type="text/css" href="css/transition.css">
    <link rel="stylesheet" href="css/chat.css">
	<title>SIS BIO BANK</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Belanosima:wght@700&family=Karla:wght@500&display=swap" rel="stylesheet">
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&display=swap" rel="stylesheet">
</head>
<body>
	<section id="page">
		<section id="sidebar">
            <br>
		<a href="#"><img src="images/logo.png" alt="Arava" class="logo"></a>
		<center>
			<a href="home.html">
                <button id="sidebar-buttons">
                    <img class="icons" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAACYElEQVR4nO2Z227TQBCG9542s04TSClc8ybl9DoBeYdKFn0C1AfoA1Ck8gDlCgFSOVQcqjYg0XKZUO86KQcJLkATr1MnipM0id1daX9plMg7sufbGe9ONow5OTk5OTnNUaH34Lrk4okC7CiO/4wywI7kuN1eXLsxCUR44QHz0SY5Soo1E6Sbia6jeNys1mvMMDWr9ZrkuJXEmOmYlJOJEIlaFVyOy0y0WZaS1DHDpcbF6UAKljI1I1HJX1UgjsmiEt60FkRyPEotrUdWgigIuAL8cbbpiZ8R+J5VIBSw5Lir94W/ZPr726gUlAsHCT3/lgL8RjZJjacg3uhy+kI79UkZVyTHhobZ6ywElUJB+mtcfB0LUQrKNOva//NJ+f61ZOz70r2rCvBAl9mH00vB5UJA6EEK8FcPBMTvYQ9P1F70lyTHdzoTDcrCoE+zWq8pwH3ts5s7iIb4qB/4h0zP5KdhMDGE2NOZOKTZH3VvSaUH+DJXkM6CqFLqdXt9QLM4eI36oox3ojEKYpzmBjIMImuMYOJr+H6STBQGki4n+hxWQtklh/vz6KzVrCCTQCTSWRhYBMSVWSFmBjkPxLTLcu4g00CQaHOMN0pqBv1VdtEgkovX54XIU2paEAXiFS2dJkAY2TROK+VAbMuI5Niy5ThIcmxlOkmOm9ppK90nmaJWBZfPDhFxs29QgXgx7ojSeAPxvHe6aLUBRrTZPdOp2maWSYF4qmPfYdLDuymyR/Nq7PJUM/4FuZHEHXp4uzugQKxbXFYP+yhDz79DKbLinYHuHz47vUw4OTk5OTmx2fQfpRQyY5DVBVEAAAAASUVORK5CYII=" alt="performance-macbook"/><p class="button-text">Dashboard</p>
                </button>
            </a>

			<button id="sidebar-buttons">
				<img class="icons" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAkklEQVR4nO3UQQoCMQwF0Nwg7a3sXMg2Gz1ru47xBoqg4GIKiZMIg37orsmDpi3AP9pwrosgDUl0Uy2kwZmKGjA1Ty+kdT3wLIraD78LiHb4bkCaDN/riGTW52uAbHwH4gZg65zrwQxcEp0ijg7WmvsC2M6mArcHiB98ghaAM5XHQMMAS65Ix1DgHYHIyOTC7DN3KHF5WQojT4YAAAAASUVORK5CYII=" alt="performance-macbook"/><p class="button-text"><b>Chats</b></p>
			</button>

			<a href="reminders.html">
			<button id="sidebar-buttons">
				<img class="icons" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAACmUlEQVR4nO1ZS2sUQRDunHezXZO4Rq8iohdN1JsiiAiKP0TRY5Tdqo3s3/DxB0zE5OTjECKa36DJOQpx9lE9bnJfqXmYFVx3JjsvpD9oGHpqeuqjXnSVUhYWFlPDq+FtBnzJgLtG06EBGma6NB0aTTsM9MJovDU1gZ+zzXNG46fMFZ+wGPCjV2uePRYJhtYNBuLgIPrBgMTQuLS/sFxRGWN/YbliNC0yUEv+HZLps9O6ntgSRyTwlVtvV1VB6M4/mWWg1YhMIstE7iQkhkrNqIIxVGqGAddC79iKHdiROxVpib9bBt0gGcRIAJKdQmuQKhkYcCXU7Xkc4d1Q+OLovlejqwz4wWg8CBa993TzisoRRtNimJ534ggPRHjUrXpzKxcYsOvV8L5bf3xKljwzUEfeqRzdywREBhOFo9w9usdAGwz0kB26ZzR+N5q+9R266+8BrmepfBz9EhBBd1DFuhA4qr64d1Bpn5R3f3yvcTu9Co/b/wkR+pw2kXVxI3Enn4zGvb7TvMOAjxjojcoRZhoiQbBTp+/Qg84JOi1LnmWvO4/ns1Q8VSL+vqbLRuM7P6sF663RjSWVM8y0RMoCY4mUqLKnFOzFV/YU0q+t7ENb2cFW9gC2sucEYwtiyWCmtYit7CnD2Mqu7J19aO/sqcTI2AZd8Xf2bpIG3biWaRnu7OZ3yxS/ThT2x11BN76lSgYGehrq9myisLTso7GCmFKVBL25dk1cObTIzVgfycwuJLNankEPvQ512oz9oYy3ZMwVxspakZbpBZaISPQ83TyT6AAZPI6Qcf0hi24s5THFcuvtqvxLYiJyJyHRd/DasQ4MLENbxY+naTOxJcYlABl3Sdrze1pZK6/9vtkXyU6xA9vCwkL9C78AFFy1Bcb9IR4AAAAASUVORK5CYII=" alt="performance-macbook"/><p class="button-text">Reminders</p>
			</button>
			</a>

			<a href="timetable.html">
				<button id="sidebar-buttons">
				<img class="icons" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAYAAAAeP4ixAAAACXBIWXMAAAsTAAALEwEAmpwYAAACkklEQVR4nO1ZW2sTURA+Xl+qnUlF+h+qf0Cf1UcV2r7ri0/SNg1CZiIEfPCC/gilSn+If6Gx4u1Ni9iciZcq9sGV2ZzFVHKyya5mN+R8MBD2ZIb5zlyzMSYgICBgYhGZ5nGL/ECAPghyVEoBfi/A99RXLxGLdL9wR3FYQnTXSyRmixy1K/Vzo0QyMT5a/LPptSuN80lkSuHQf9WTsjnkQSCShhARDKkVDVXskyJmaoiYEVE6PSmbQx4EImkIEcGQWtF0FbtMiJipIWL+dajHrSdlc8iDQCQNISJ4MLUic+NYBxrLAvzMIr0U4G8C/N0ivRPgTQFejEzzaKlTS4CuWuTXaZ3KIr0pLZEDLwaBtgR4rV25fWZnvjajop8FqCrArV5SkWkeHmi4CLFIPy3yzcgsH/ER1zOLvGKR9we+bSySRAcaF4aNdGeWLiZkLNYve4mkJ0V+PS3aJN81EqPatUir7hJeaZPI7VBWPQFaSmrCl04ywG7cvYBedG3wYm6HsurF7bTrxFpWuwKNdXcZT3M7lFUvng3I0e4cLWS1267QWXcZ27kdyqpngX6ozqdTt072O9+do4U0u6rriHzJ7VBWPQH67CMiwNcEaM852So5ke5w02GXPNuZr80I0JM/w5Ef67O01NJ1pq9DYxWgap9OtidQv55+GVRzhDf+Png+fiLc6m2/AnSnN0o+dNsvbzviS6bgf5DfuoG4Mqq+6O7lG4jjhkW+4ojs69phhkRntn5JdSzyr74rShGwyI8SMhZpVVPG9103zaupS2MRiIw5ZJEe9taMQGNdO9LH080TKnF30sJ2K4lGQkl41/ii08y6aT9ItCZKk04+aANwP3U340YQt2H6GkcCeEO7k6+wfwN1DDNWSYl2SgAAAABJRU5ErkJggg==" alt="performance-macbook"/><p class="button-text">Timetable</p>
			</button>
			</a>
		</center>
		<a href="about.html"><img src="images/twelve.png" class="about"></a>
	</section>


    <section id="main-content">
        <p class="myname"><span id="nameDisplay"></span></p>
        <div class="messages" id="messages">
            <center>
                <img src="images/twelve.png" alt="MYSTIC" class="logoinchat">
            </center>
            <!-- Chat messages will be appended here dynamically -->
        </div>
        <form onsubmit="return false;" id="messageForm">
            <div id="sendMsg" class="type">
                <input type="text" id="msgTxt" placeholder="Message..." class="messagetext">
                <input type="submit" id="msgBtn" value="Send" onclick="module.sendMsg()" class="sendbutton" disabled>
            </div>
        </form>
    </section>
	
    <audio id="sendSound" src="send.mp3"></audio>
    <audio id="receiveSound" src="recieve.mp3"></audio>
	<script>
        module = {};
    </script>
    <script type="module"> 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
        import { getDatabase, ref, set, remove, onChildAdded, onChildRemoved } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-analytics.js";
    
        const firebaseConfig = {
    apiKey: "AIzaSyCNFM_a_I02ovJA12kzeVdX-PSFZaM_OOc",
    authDomain: "com-chat-14297.firebaseapp.com",
    projectId: "com-chat-14297",
    storageBucket: "com-chat-14297.appspot.com",
    messagingSenderId: "990736624014",
    appId: "1:990736624014:web:d5b3d7864acff57fe65cdf",
    measurementId: "G-CMGJ6GQDC0"
    };
      
         // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const analytics = getAnalytics(app);
    
        var msgTxt = document.getElementById('msgTxt');
    var msgBtn = document.getElementById('msgBtn');
    var nameDisplay = document.getElementById('nameDisplay');
    var sender;
    
    // Check if sender name is stored in localStorage
    if (localStorage.getItem('sender')) {
    sender = localStorage.getItem('sender');
    } else {
    // Prompt user for name if not stored
    sender = prompt('What is your name?');
    localStorage.setItem('sender', sender);
    }
    
    // Set the text content of the h1 element to the sender's name
    nameDisplay.textContent = sender;
    
    // Add an input event listener to the input field
    msgTxt.addEventListener('input', function() {
    // Enable the button if there is text, disable it if the input is empty
    msgBtn.disabled = msgTxt.value.trim() === '';
    });
    // TO SEND MESSAGES
    module.sendMsg = function sendMsg() {
    // Disable the submit button before sending the message
    msgBtn.disabled = true;
    
    var msg = msgTxt.value;
    var timestamp = new Date().getTime();
    set(ref(db, "messages/" + timestamp), {
        msg: msg,
        sender: sender
    }).then(() => {
        // Clear the input field and re-enable the submit button after sending
        msgTxt.value = '';
        msgBtn.disabled = false;
    
        // Scroll down to the new message
        scrollMessagesToBottom();
    }).catch(error => {
        // Handle any errors here
        console.error("Error sending message:", error);
        msgBtn.disabled = false; // Re-enable the button if there's an error
    });
    }
    
    // TO RECEIVE MSG
    onChildAdded(ref(db, "messages"), (data) => {
    if (data.val().sender == sender) {
        messages.innerHTML += "<div style=justify-content:end class=outer id=" + data.key + "><div id=inner class=me>" + processMessage(data.val().msg) + "<button id=dltMsg onclick=module.dltMsg(" + data.key + ")>X</button></div></div>";
    } else {
        messages.innerHTML += "<div class=outer id=" + data.key + "><div class=notMe> <b class=nameuser>" + data.val().sender + ":</b><br>" + processMessage(data.val().msg) + "</div></div>";
    }
    
    // Scroll down to the new message
    scrollMessagesToBottom();
    
    // Check if #inner has been added
    const innerElement = document.getElementById("inner");
    if (innerElement) {
        // Play the sound
        const audio = document.getElementById("sound");
        audio.play();
    }
    });
    
    // Function to process messages and identify image and video links
    function processMessage(msg) {
    // Regular expression to check if the message contains a valid URL
    const urlRegex = /(https?:\/\/[^\s]+)/g;
    
    // Check if the message contains a valid URL
    if (urlRegex.test(msg)) {
        // Replace the URL with an image or video preview
        msg = msg.replace(urlRegex, (match) => {
            // Check if the URL is from Firebase Storage
            if (match.includes("https://firebasestorage.googleapis.com")) {
                return `<div class="media-container" data-url="${match}"><h1 class="media">Media: Tap to show</h1></div>`;
            } else if (/\.(jpeg|jpg|gif|png)$/.test(match.toLowerCase())) {
                // Check if the URL is an image
                return `<div class="image-container"><img src="${match}" alt="Image"></div>`;
            } else if (/\.(mp4|ogg|webm)$/.test(match.toLowerCase())) {
                // Check if the URL is a video
                return `<div class="video-container"><video controls width="320" height="240"><source src="${match}" type="video/mp4"></video></div>`;
            } else {
                // If it's not an image or video, display the custom message as a clickable link
                return `<div class="link-container">Sent you a link: <a href="${match}" target="_blank" rel="noopener noreferrer">OPEN</a></div>`;
            }
        });
    }
    
    return msg;
    }
    
    // Scroll down to the bottom of the messages container
    function scrollMessagesToBottom() {
    var messagesContainer = document.getElementById("messages");
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    // TO DELETE MSG
    module.dltMsg = function dltMsg(key) {
    remove(ref(db, "messages/" + key));
    }
    // Function to sort messages by timestamp
    function sortMessagesByTimestamp(messages) {
    return messages.sort((a, b) => a.timestamp - b.timestamp);
    }
    // WHEN MSG IS DELETED
    onChildRemoved(ref(db, "messages"), (data) => {
    var msgBox = document.getElementById(data.key);
    messages.removeChild(msgBox);
    });
    
    
    // TO DELETE MSG
    module.dltMsg = function dltMsg(key){
    remove(ref(db,"messages/"+key));
    }
    
    // WHEN MSG IS DELETED
    onChildRemoved(ref(db,"messages"),(data)=>{
    var msgBox = document.getElementById(data.key);
    messages.removeChild(msgBox);
    })
    
      </script>
     
    
    <script>
    document.addEventListener('copy', function (e) {
        var selectedText = window.getSelection().toString();
        var formattedText = "<reply>" + selectedText + "</reply> -- ";
        e.clipboardData.setData('text/html', formattedText);
        e.clipboardData.setData('text/plain', formattedText);
        e.preventDefault();
    });
    </script>
    
    
      </script>
    
    
    <script>
    document.addEventListener('copy', function (e) {
        var selectedText = window.getSelection().toString();
        var formattedText = "<reply>" + selectedText + "</reply><br>  ";
        e.clipboardData.setData('text/html', formattedText);
        e.clipboardData.setData('text/plain', formattedText);
        e.preventDefault();
    });
    </script>
</body>
<script type="text/javascript" src="js/clock.js"></script>
</html>